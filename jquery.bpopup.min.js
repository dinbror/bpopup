(function(d){'use strict';d.fn.bPopup=function(z,E){if(d.isFunction(z)){E=z;z=null}var a=d.extend({},d.fn.bPopup.defaults,z);if(!a.scrollBar){d('html').css('overflow','hidden')}var b=this,i=d(document),N=window,j=d(N),s=F(),t=G(),O='__b-popup',P=(/OS 6(_\d)+/i).test(navigator.userAgent),A=200,u=0,f,h,m,n,g,v,w,x,y,H,I;b.close=function(){o()};b.reposition=function(c){J(c)};return b.each(function(){if(d(this).data('bPopup'))return;Q()});function Q(){p(a.onOpen);u=(j.data('bPopup')||0)+1,f=O+u+'__',m=a.position[1]!=='auto',n=a.position[0]!=='auto',g=a.positionStyle==='fixed',x=b.outerHeight(true),y=b.outerWidth(true);a.loadUrl?R():B()};function R(){a.contentContainer=d(a.contentContainer||b);switch(a.content){case('iframe'):var k=d('<iframe class="b-iframe" '+a.iframeAttr+'></iframe>');k.appendTo(a.contentContainer);x=b.outerHeight(true);y=b.outerWidth(true);B();k.attr('src',a.loadUrl);p(a.loadCallback);break;case('image'):B();d('<img />').load(function(){p(a.loadCallback);K(d(this))}).attr('src',a.loadUrl).hide().appendTo(a.contentContainer);break;default:B();d('<div class="b-ajax-wrapper"></div>').load(a.loadUrl,a.loadData,function(c,e,l){p(a.loadCallback,e);K(d(this))}).hide().appendTo(a.contentContainer);break}b.addClass('loader')};function B(){if(a.modal){d('<div class="b-modal '+f+'"></div>').css({backgroundColor:a.modalColor,position:'fixed',top:0,right:0,bottom:0,left:0,opacity:0,zIndex:a.zIndex+u}).appendTo(a.appendTo).fadeTo(a.speed,a.opacity)}C();b.data('bPopup',a).data('id',f).css({left:a.transition=='slideIn'||a.transition=='slideBack'?(a.transition=='slideBack'?i.scrollLeft()+t:(w+y)*-1):q(!(!a.follow[0]&&n||g)),position:a.positionStyle||'absolute',top:a.transition=='slideDown'||a.transition=='slideUp'?(a.transition=='slideUp'?i.scrollTop()+s:v+x*-1):r(!(!a.follow[1]&&m||g)),zIndex:a.zIndex+u+1}).each(function(){if(a.appending){d(this).appendTo(a.appendTo)}});L(true)};function o(){if(a.modal){d('.b-modal.'+b.data('id')).fadeTo(a.speed,0,function(){d(this).remove()})}S();clearTimeout(I);L();return false};function J(e){s=F();t=G();h=D();if(h.x||h.y){clearTimeout(H);H=setTimeout(function(){C();e=e||a.followSpeed;var c={};if(h.x){c.left=a.follow[0]?q(true):'auto'}if(h.y){c.top=a.follow[1]?r(true):'auto'}b.dequeue().each(function(){if(g){d(this).css({'left':w,'top':v})}else{d(this).animate(c,e,a.followEasing)}})},50)}};function K(c){var e=c.width(),l=c.height(),k={};a.contentContainer.css({height:l,width:e});if(l>=b.height()){k.height=b.height()}if(e>=b.width()){k.width=b.width()}x=b.outerHeight(true),y=b.outerWidth(true);C();a.contentContainer.css({height:'auto',width:'auto'});k.left=q(!(!a.follow[0]&&n||g)),k.top=r(!(!a.follow[1]&&m||g));b.animate(k,250,function(){c.show();h=D()})};function T(){j.data('bPopup',u);b.delegate('.bClose, .'+a.closeClass,'click.'+f,o);if(a.modalClose){d('.b-modal.'+f).css('cursor','pointer').bind('click',o)}if(!P&&(a.follow[0]||a.follow[1])){j.bind('scroll.'+f,function(){if(h.x||h.y){var c={};if(h.x){c.left=a.follow[0]?q(!g):'auto'}if(h.y){c.top=a.follow[1]?r(!g):'auto'}b.dequeue().animate(c,a.followSpeed,a.followEasing)}}).bind('resize.'+f,function(){J()})}if(a.escClose){i.bind('keydown.'+f,function(c){if(c.which==27){o()}})}};function S(){if(!a.scrollBar){d('html').css('overflow','auto')}d('.b-modal.'+f).unbind('click');i.unbind('keydown.'+f);j.unbind('.'+f).data('bPopup',(j.data('bPopup')-1>0)?j.data('bPopup')-1:null);b.undelegate('.bClose, .'+a.closeClass,'click.'+f,o).data('bPopup',null)};function L(e){switch(e?a.transition:a.transitionClose||a.transition){case"slideIn":l({left:e?q(!(!a.follow[0]&&n||g)):i.scrollLeft()-(y||b.outerWidth(true))-A});break;case"slideBack":l({left:e?q(!(!a.follow[0]&&n||g)):i.scrollLeft()+t+A});break;case"slideDown":l({top:e?r(!(!a.follow[1]&&m||g)):i.scrollTop()-(x||b.outerHeight(true))-A});break;case"slideUp":l({top:e?r(!(!a.follow[1]&&m||g)):i.scrollTop()+s+A});break;default:b.stop().fadeTo(a.speed,e?1:0,function(){M(e)})}function l(c){b.css({display:'block',opacity:1}).animate(c,a.speed,a.easing,function(){M(e)})}};function M(c){if(c){T();b.removeClass('loader');p(E);if(a.autoClose){I=setTimeout(o,a.autoClose)}}else{b.hide();p(a.onClose);if(a.loadUrl){a.contentContainer.empty();b.css({height:'auto',width:'auto'})}}};function q(c){return c?w+i.scrollLeft():w};function r(c){return c?v+i.scrollTop():v};function p(c,e){d.isFunction(c)&&c.call(b,e)};function C(){v=m?(typeof a.position[1]=='function'?a.position[1].call(b):a.position[1]):Math.max(0,((s-b.outerHeight(true))/2)-a.amsl),w=n?(typeof a.position[0]=='function'?a.position[0].call(b):a.position[0]):(t-b.outerWidth(true))/2,h=D()};function D(){return{x:t>b.outerWidth(true),y:s>b.outerHeight(true)}};function F(){return j.height()};function G(){return j.width()}};d.fn.bPopup.defaults={amsl:50,appending:true,appendTo:'body',autoClose:false,closeClass:'b-close',content:'ajax',contentContainer:false,easing:'swing',escClose:true,follow:[true,true],followEasing:'swing',followSpeed:500,iframeAttr:'scrolling="no" frameborder="0"',loadCallback:false,loadData:false,loadUrl:false,modal:true,modalClose:true,modalColor:'#000',onClose:false,onOpen:false,opacity:0.7,position:['auto','auto'],positionStyle:'absolute',scrollBar:true,speed:250,transition:'fadeIn',transitionClose:false,zIndex:9997}})(jQuery);